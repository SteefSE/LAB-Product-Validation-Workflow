# LAB Product Validation Workflow - FIXED Configuration
# Compatible with Mendix 10.18.1 and Workflow Commons 3.12.1

project:
  name: "LABProductValidationWorkflow"
  description: "Complete LAB Product Validation Workflow System - FIXED VERSION"
  version: "1.0.1"
  mendix_version: "10.18.1"
  workflow_commons_version: "3.12.1"
  target_platform: "mendix_studio_pro"

# Workflow Configuration
workflow:
  context_entity: "ProductValidation"
  name: "LAB_ProductValidation"
  description: "Main validation workflow with TRUE/FALSE outcomes"
  workflow_type: "sequential"
  max_concurrent_instances: 50
  timeout_hours: 72

# Entity Configuration (Compatible with Mendix 10.18.1)
entities:
  context_entity: "ProductValidation"
  workflow_entities:
    - "System.WorkflowUserTask"    # For active tasks (10.18.1 compatible)
    - "System.Workflow"            # For workflow instances
    - "Administration.Account"     # For user references
  
  # AVOID these entities in Mendix 10.18.1:
  deprecated_entities:
    - "System.WorkflowEndedUserTask"     # Only available in Mendix 11+
    - "WorkflowCommons.UserTaskView"     # Deprecated in WF Commons 4.0+
    - "WorkflowCommons.WorkflowView"     # Deprecated in WF Commons 4.0+

# Microflows Configuration
microflows:
  - name: "ACT_CreateTask"
    type: "action"
    description: "Creates new task with proper assignment and initial status"
    parameters:
      - name: "TaskTitle"
        type: "String"
      - name: "AssignedUser"
        type: "Administration.Account"
      - name: "WorkflowContext"
        type: "ProductValidation"
    return_type: "System.WorkflowUserTask"
    security_roles: ["LABAdmin", "LABTechnician"]
    compatibility: "mendix_10_18_1"

  - name: "ACT_AssignTask"
    type: "action"
    description: "Assigns tasks to users based on role and workload"
    parameters:
      - name: "Task"
        type: "System.WorkflowUserTask"
      - name: "NewAssignee" 
        type: "Administration.Account"
    return_type: "Boolean"
    security_roles: ["LABAdmin"]
    compatibility: "mendix_10_18_1"

  - name: "ACT_CompleteTask"
    type: "action"
    description: "Marks task as completed, triggers workflow progression"
    parameters:
      - name: "Task"
        type: "System.WorkflowUserTask"
      - name: "CompletionData"
        type: "String"
    return_type: "Boolean"
    security_roles: ["LABAdmin", "LABTechnician"]
    compatibility: "mendix_10_18_1"

  - name: "SUB_CheckUserPermissions"
    type: "submicroflow"
    description: "Validates user access rights for specific actions"
    parameters:
      - name: "User"
        type: "Administration.Account"
      - name: "RequiredRole"
        type: "String"
      - name: "EntityToAccess"
        type: "String"
    return_type: "Boolean"
    security_roles: ["LABAdmin", "LABTechnician", "LABViewer"]
    compatibility: "mendix_10_18_1"

  - name: "ACT_ProcessImageQuality"
    type: "action"
    description: "Validates image quality and determines approval status"
    parameters:
      - name: "ImageAcquisition"
        type: "ImageAcquisition"
      - name: "QualityThreshold"
        type: "Decimal"
    return_type: "Boolean"
    security_roles: ["LABAdmin", "LABTechnician"]
    compatibility: "mendix_10_18_1"

  - name: "DS_GetMyTasks"
    type: "datasource"
    description: "Returns tasks filtered by current user with XPath constraints"
    parameters:
      - name: "CurrentUser"
        type: "Administration.Account"
    return_type: "List of System.WorkflowUserTask"
    security_roles: ["LABAdmin", "LABTechnician", "LABViewer"]
    xpath_constraint: "[System.WorkflowUserTask_Account = $CurrentUser]"
    compatibility: "mendix_10_18_1"

  - name: "ACT_InitiateWorkflow"
    type: "action"
    description: "Initiates new LAB Product Validation workflow instance"
    parameters:
      - name: "ProductValidation"
        type: "ProductValidation"
      - name: "InitiatingUser"
        type: "Administration.Account"
    return_type: "System.Workflow"
    security_roles: ["LABAdmin", "LABTechnician"]
    compatibility: "mendix_10_18_1"

  - name: "ACT_GenerateValidationReport"
    type: "action"
    description: "Generates comprehensive validation report with all workflow data"
    parameters:
      - name: "ProductValidation"
        type: "ProductValidation"
      - name: "ReportFormat"
        type: "ReportFormat"
    return_type: "ValidationReport"
    security_roles: ["LABAdmin", "LABTechnician"]
    compatibility: "mendix_10_18_1"

  - name: "ACT_UpdateAuditTrail"
    type: "action"
    description: "Updates workflow audit trail with action details"
    parameters:
      - name: "ActionType"
        type: "AuditActionType"
      - name: "EntityAffected"
        type: "String"
      - name: "PerformedBy"
        type: "Administration.Account"
      - name: "ChangeDetails"
        type: "String"
    return_type: "WorkflowAuditTrail"
    security_roles: ["LABAdmin", "LABTechnician"]
    compatibility: "mendix_10_18_1"

  - name: "ACT_ValidateWorkflowOutcome"
    type: "action"
    description: "Validates final workflow outcome and determines TRUE/FALSE result"
    parameters:
      - name: "ProductValidation"
        type: "ProductValidation"
      - name: "ValidationCriteria"
        type: "String"
    return_type: "Boolean"
    security_roles: ["LABAdmin"]
    compatibility: "mendix_10_18_1"

# Workflow Stages (Sequential Processing)
workflow_stages:
  - name: "ImageAcquisition"
    description: "Initial image capture and basic quality check"
    task_template: "ImageAcquisitionTask" 
    estimated_duration_minutes: 30
    required_role: "LABTechnician"
    success_criteria: "Image captured with acceptable quality"
    
  - name: "QualityValidation"
    description: "Critical quality validation checkpoint - TRUE/FALSE decision"
    task_template: "ImageQualityValidationTask"
    estimated_duration_minutes: 15
    required_role: "LABTechnician"
    success_criteria: "Quality meets minimum threshold"
    decision_point: true
    on_failure: "terminate_workflow"
    
  - name: "DetailedAcquisition"
    description: "Enhanced image processing if quality approved"
    task_template: "DetailedImageAcquisitionTask"
    estimated_duration_minutes: 45
    required_role: "LABTechnician"
    success_criteria: "Enhanced image processing completed"
    conditional: true
    condition: "Previous stage passed quality validation"
    
  - name: "Analysis"
    description: "Comprehensive image analysis and processing"
    task_template: "ImageAnalysisTask"
    estimated_duration_minutes: 60
    required_role: "LABTechnician"
    success_criteria: "Analysis completed with confidence > 90%"
    
  - name: "KPIExtraction"
    description: "Extract key performance indicators from analysis"
    task_template: "KPIExtractionTask"
    estimated_duration_minutes: 20
    required_role: "LABTechnician"
    success_criteria: "All required KPIs extracted successfully"
    
  - name: "LABValidation"
    description: "Final validation and approval by LAB administrator"
    task_template: "LABValidationTask"
    estimated_duration_minutes: 30
    required_role: "LABAdmin"
    success_criteria: "Final approval granted"
    
  - name: "ReportGeneration"
    description: "Generate comprehensive validation report"
    task_template: "ReportGenerationTask"
    estimated_duration_minutes: 15
    required_role: "LABTechnician"
    success_criteria: "Report generated and distributed"

# Enumerations
enumerations:
  - name: "ValidationStatus"
    values:
      - name: "Pending"
        caption: "Pending"
        description: "Validation request received and queued"
      - name: "InProgress"
        caption: "In Progress" 
        description: "Validation currently being processed"
      - name: "Approved"
        caption: "Approved"
        description: "Validation passed all requirements"
      - name: "Rejected"
        caption: "Rejected"
        description: "Validation failed requirements"
      - name: "OnHold"
        caption: "On Hold"
        description: "Validation temporarily suspended"
      - name: "Completed"
        caption: "Completed"
        description: "Validation process fully completed"

  - name: "Priority"
    values:
      - name: "Low"
        caption: "Low"
        description: "Standard processing priority"
      - name: "Medium"
        caption: "Medium"
        description: "Elevated processing priority"
      - name: "High"
        caption: "High"
        description: "High priority processing"
      - name: "Critical"
        caption: "Critical"
        description: "Immediate processing required"

  - name: "ImageQuality"
    values:
      - name: "Poor"
        caption: "Poor"
        description: "Below acceptable quality standards"
      - name: "Fair"
        caption: "Fair"
        description: "Meets minimum quality requirements"
      - name: "Good"
        caption: "Good"
        description: "Good quality, suitable for processing"
      - name: "Excellent"
        caption: "Excellent"
        description: "Excellent quality, optimal for analysis"
      - name: "Outstanding"
        caption: "Outstanding"
        description: "Exceptional quality, exceeds requirements"

  - name: "WorkflowStage"
    values:
      - name: "ImageAcquisition"
        caption: "Image Acquisition"
        description: "Initial image capture phase"
      - name: "QualityValidation"
        caption: "Quality Validation"
        description: "Critical quality assessment phase"
      - name: "DetailedAcquisition"
        caption: "Detailed Acquisition"
        description: "Enhanced image processing phase"
      - name: "Analysis"
        caption: "Analysis"
        description: "Comprehensive analysis phase"
      - name: "KPIExtraction"
        caption: "KPI Extraction"
        description: "Key performance indicator extraction phase"
      - name: "LABValidation"
        caption: "LAB Validation"
        description: "Final validation and approval phase"
      - name: "ReportGeneration"
        caption: "Report Generation"
        description: "Final report creation and distribution phase"

  - name: "ApprovalLevel"
    values:
      - name: "Technician"
        caption: "Technician"
        description: "Technician-level approval"
      - name: "Supervisor"
        caption: "Supervisor"
        description: "Supervisor-level approval required"
      - name: "Manager"
        caption: "Manager"
        description: "Manager-level approval required"
      - name: "Director"
        caption: "Director"
        description: "Director-level approval required"

# Security Roles Configuration (Mendix 10.18.1 Compatible)
security_roles:
  - name: "LABAdmin"
    description: "Full system administration and workflow management"
    permissions:
      entity_access:
        ProductValidation: "CRUD"
        ImageAcquisition: "CRUD"
        ImageQualityValidation: "CRUD"
        DetailedImageAcquisition: "CRUD"
        ImageAnalysis: "CRUD"
        KPIExtraction: "CRUD"
        ValidationResult: "CRUD"
        ValidationReport: "CRUD"
        WorkflowAuditTrail: "CRUD"
        System.WorkflowUserTask: "CRUD"
        System.Workflow: "CRUD"
        Administration.Account: "R"
      page_access:
        - "WorkflowAdminCenter"
        - "WorkflowAdminDashboard"
        - "TaskAssignment_Management"
        - "UserManagement_Workflow"
        - "SystemConfiguration"
        - "AuditTrailViewer"
        - "TaskInbox"
        - "ValidationResultPage"
        - "ReportGenerationPage"
      microflow_access:
        - "ACT_CreateTask"
        - "ACT_AssignTask"
        - "ACT_CompleteTask"
        - "SUB_CheckUserPermissions"
        - "ACT_ProcessImageQuality"
        - "DS_GetMyTasks"
        - "ACT_InitiateWorkflow"
        - "ACT_GenerateValidationReport"
        - "ACT_UpdateAuditTrail"
        - "ACT_ValidateWorkflowOutcome"

  - name: "LABTechnician"
    description: "Task execution and data entry for assigned workflows"
    permissions:
      entity_access:
        ProductValidation:
          access: "R"
        ImageAcquisition:
          access: "CRUD"
          xpath: "[TechnicianID = '[%CurrentUser%]']"
        ImageQualityValidation:
          access: "CRUD" 
          xpath: "[ValidatedBy = '[%CurrentUser%]']"
        DetailedImageAcquisition:
          access: "CRUD"
          xpath: "[TechnicianID = '[%CurrentUser%]']"
        ImageAnalysis:
          access: "CRUD"
          xpath: "[ProcessedBy = '[%CurrentUser%]']"
        KPIExtraction:
          access: "CRUD"
          xpath: "[ExtractedBy = '[%CurrentUser%]']"
        ValidationResult: "R"
        ValidationReport: "R"
        WorkflowAuditTrail:
          access: "R"
          xpath: "[PerformedBy = '[%CurrentUser%]']"
        System.WorkflowUserTask:
          access: "RU"
          xpath: "[System.WorkflowUserTask_Account = '[%CurrentUser%]']"
        System.Workflow: "R"
        Administration.Account: "R"
      page_access:
        - "TaskInbox"
        - "TaskDashboard"
        - "ImageAcquisitionTask"
        - "ImageQualityValidationTask"
        - "DetailedImageAcquisitionTask"
        - "ImageAnalysisTask"
        - "KPIExtractionTask"
        - "ReportGenerationPage"
      microflow_access:
        - "ACT_CompleteTask"
        - "SUB_CheckUserPermissions"
        - "ACT_ProcessImageQuality"
        - "DS_GetMyTasks"
        - "ACT_InitiateWorkflow"
        - "ACT_GenerateValidationReport"
        - "ACT_UpdateAuditTrail"

  - name: "LABViewer"
    description: "Read-only access to completed workflows and public reports"
    permissions:
      entity_access:
        ProductValidation:
          access: "R"
          xpath: "[Status = 'Completed']"
        ImageAcquisition:
          access: "R"
          xpath: "[ProductValidation/Status = 'Completed']"
        ImageQualityValidation:
          access: "R"
          xpath: "[ImageAcquisition/ProductValidation/Status = 'Completed']"
        DetailedImageAcquisition:
          access: "R"
          xpath: "[ProductValidation/Status = 'Completed']"
        ImageAnalysis:
          access: "R"
          xpath: "[ProductValidation/Status = 'Completed']"
        KPIExtraction:
          access: "R"
          xpath: "[ProductValidation/Status = 'Completed']"
        ValidationResult: "R"
        ValidationReport: "R"
        WorkflowAuditTrail:
          access: "R"
          xpath: "[ProductValidation/Status = 'Completed']"
        System.WorkflowUserTask:
          access: "R"
          xpath: "[System.Workflow/System.Workflow_ProductValidation/Status = 'Completed']"
        System.Workflow:
          access: "R"
          xpath: "[System.Workflow_ProductValidation/Status = 'Completed']"
        Administration.Account: "R"
      page_access:
        - "PublicReportViewer"
        - "WorkflowStatusViewer"
        - "ValidationResultViewer"
        - "CompletedWorkflowsOverview"
      microflow_access:
        - "SUB_CheckUserPermissions"
        - "DS_GetWorkflowHistory"

# Pages Configuration
pages:
  # Administrator Pages
  - name: "WorkflowAdminCenter"
    description: "Central administration hub with complete workflow oversight"
    page_type: "admin_dashboard"
    required_role: "LABAdmin"
    components:
      - workflow_overview_grid
      - task_assignment_panel
      - user_management_section
      - system_metrics_dashboard
    compatibility: "mendix_10_18_1"

  - name: "WorkflowAdminDashboard"
    description: "Real-time metrics and performance indicators"
    page_type: "dashboard"
    required_role: "LABAdmin"
    components:
      - kpi_charts
      - workflow_statistics
      - performance_metrics
      - alert_notifications
    compatibility: "mendix_10_18_1"

  - name: "TaskAssignment_Management"
    description: "Advanced task routing and assignment management"
    page_type: "management"
    required_role: "LABAdmin"
    components:
      - task_queue_grid
      - assignment_rules_editor
      - workload_balancing_tools
      - escalation_settings
    compatibility: "mendix_10_18_1"

  # User/Technician Pages
  - name: "TaskInbox"
    description: "Personal task management and execution interface"
    page_type: "task_list"
    required_role: "LABTechnician"
    components:
      - my_tasks_grid
      - task_priority_indicators
      - quick_action_buttons
      - task_history_panel
    compatibility: "mendix_10_18_1"

  - name: "ImageAcquisitionTask"
    description: "Image capture and initial quality assessment interface"
    page_type: "task_form"
    required_role: "LABTechnician"
    components:
      - image_upload_widget
      - capture_settings_form
      - quality_preview_panel
      - metadata_entry_form
    compatibility: "mendix_10_18_1"

  - name: "ImageQualityValidationTask"
    description: "Critical quality validation interface with TRUE/FALSE decision"
    page_type: "validation_form"
    required_role: "LABTechnician"
    components:
      - image_quality_analyzer
      - quality_metrics_display
      - approval_decision_buttons
      - rejection_reason_form
    compatibility: "mendix_10_18_1"

  - name: "DetailedImageAcquisitionTask"
    description: "Enhanced image processing and enhancement interface" 
    page_type: "processing_form"
    required_role: "LABTechnician"
    components:
      - enhancement_tools_panel
      - before_after_comparison
      - processing_parameters_form
      - quality_improvement_metrics
    compatibility: "mendix_10_18_1"

  # Viewer Pages
  - name: "PublicReportViewer"
    description: "Read-only access to completed validation reports"
    page_type: "report_viewer"
    required_role: "LABViewer"
    components:
      - report_list_grid
      - report_preview_panel
      - search_and_filter_tools
      - export_options
    compatibility: "mendix_10_18_1"

  - name: "WorkflowStatusViewer"
    description: "Monitor workflow progress and status updates"
    page_type: "status_monitor" 
    required_role: "LABViewer"
    components:
      - workflow_status_grid
      - progress_indicators
      - timeline_visualization
      - status_filters
    compatibility: "mendix_10_18_1"

# Workflow Definition (TRUE/FALSE Decision Logic)
workflow_definition:
  name: "LAB_ProductValidation"
  description: "Complete LAB Product Validation with TRUE/FALSE outcomes"
  context_entity: "ProductValidation"
  
  # Critical Decision Point
  decision_logic:
    quality_validation_checkpoint:
      description: "Critical TRUE/FALSE decision point at image quality validation"
      condition: "ImageQualityValidation.ValidationResult = true"
      on_true: "continue_to_detailed_acquisition"
      on_false: "terminate_workflow_immediately"
      termination_reason: "Image quality below acceptable standards"
  
  # Workflow Flow
  flow_definition:
    start_condition: "ProductValidation created and assigned"
    
    stages:
      1_image_acquisition:
        task: "ImageAcquisitionTask"
        next_stage: "2_quality_validation"
        timeout_minutes: 30
        
      2_quality_validation:
        task: "ImageQualityValidationTask"
        decision_point: true
        on_pass: "3_detailed_acquisition"
        on_fail: "workflow_termination"
        timeout_minutes: 15
        critical: true
        
      3_detailed_acquisition:
        task: "DetailedImageAcquisitionTask"
        next_stage: "4_analysis"
        timeout_minutes: 45
        conditional: true
        
      4_analysis:
        task: "ImageAnalysisTask"
        next_stage: "5_kpi_extraction"
        timeout_minutes: 60
        
      5_kpi_extraction:
        task: "KPIExtractionTask"
        next_stage: "6_lab_validation"
        timeout_minutes: 20
        
      6_lab_validation:
        task: "LABValidationTask"
        next_stage: "7_report_generation"
        timeout_minutes: 30
        required_role: "LABAdmin"
        
      7_report_generation:
        task: "ReportGenerationTask"
        next_stage: "workflow_completion"
        timeout_minutes: 15
        
    end_condition: "All stages completed successfully OR quality validation failed"

# Import/Export Configuration
import_export:
  generation_mode: "individual_xml_files"  # NOT MPK for Mendix 10.18.1
  output_structure:
    - "domain-model/*.xml"      # Individual entity files
    - "enumerations/*.xml"      # Individual enumeration files
    - "microflows/*.xml"        # Individual microflow files
    - "pages/*.xml"             # Individual page files
    - "security/*.xml"          # Individual security role files
  
  import_order:
    1: "enumerations"
    2: "domain-model"
    3: "microflows"
    4: "pages"
    5: "security"
  
  dependencies:
    required_modules:
      - name: "Workflow Commons"
        version: "3.12.1"
        marketplace_url: "https://marketplace.mendix.com/link/component/117066"
      - name: "Atlas Core"
        version: "3.x"
        marketplace_url: "https://marketplace.mendix.com/link/component/117187"
      - name: "Data Widgets"
        version: "2.x"
        marketplace_url: "https://marketplace.mendix.com/link/component/116540"

# Validation and Testing
validation:
  compatibility_checks:
    - mendix_version: "10.18.1"
    - workflow_commons_version: "3.12.1"
    - entity_references: "system_entities_only"
    - xpath_syntax: "current_user_compatible"
    - no_view_entities: true
    - no_ended_user_task_entity: true
  
  test_scenarios:
    - name: "Complete Workflow Success"
      description: "Full workflow execution with quality validation PASS"
      expected_outcome: "TRUE - Workflow completed successfully"
    
    - name: "Quality Validation Failure"
      description: "Workflow terminated at quality validation checkpoint"
      expected_outcome: "FALSE - Workflow terminated due to quality failure"
    
    - name: "Role-Based Access Control"
      description: "Verify XPath constraints and role permissions"
      expected_outcome: "Users only see data they have access to"

# Generation Scripts Configuration
scripts:
  python_requirements:
    - "PyYAML>=6.0"
    - "pathlib"
    - "argparse"
  
  execution_order:
    1: "generate-domain-model.py"
    2: "generate-microflows.py"
    3: "generate-security.py"
    4: "validate-project.py"
  
  output_validation:
    check_xml_syntax: true
    validate_references: true
    verify_compatibility: true

# Troubleshooting Guide
troubleshooting:
  common_issues:
    mpk_import_errors:
      description: "MPK generation causes import errors in Mendix 10.18.1"
      solution: "Use individual XML file import instead of MPK packaging"
      
    entity_reference_errors:
      description: "References to WorkflowEndedUserTask or View Entities"
      solution: "Use System.WorkflowUserTask and avoid View Entities in 10.18.1"
      
    xpath_constraint_errors:
      description: "XPath constraints not working properly"
      solution: "Use [%CurrentUser%] syntax compatible with 10.18.1"
      
    workflow_commons_compatibility:
      description: "Workflow Commons version conflicts"
      solution: "Use exactly version 3.12.1 for Mendix 10.18.1"