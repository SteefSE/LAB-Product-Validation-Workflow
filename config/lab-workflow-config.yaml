# LAB Product Validation Workflow - Complete Configuration
# Compatible with Mendix 10.18.1 and Workflow Commons 3.12.1
project:
  name: "LABProductValidationWorkflow"
  description: "Complete LAB Product Validation Workflow System"
  version: "1.0.0"
  mendix_version: "10.18.1"
  workflow_commons_version: "3.12.1"

workflow:
  context_entity: "ProductValidation"
  name: "LAB_ProductValidation"
  description: "Main validation workflow with TRUE/FALSE outcomes"

# Microflows Configuration
microflows:
  - name: "ACT_CreateTask"
    type: "action"
    description: "Creates new task with proper assignment and initial status"
    parameters:
      - name: "TaskTitle"
        type: "String"
      - name: "AssignedUser"
        type: "Administration.Account"
      - name: "WorkflowContext"
        type: "ProductValidation"
    return_type: "System.WorkflowUserTask"
    security_roles: ["LABAdmin", "LABTechnician"]

  - name: "ACT_AssignTask"
    type: "action"
    description: "Assigns tasks to users based on role and workload"
    parameters:
      - name: "Task"
        type: "System.WorkflowUserTask"
      - name: "NewAssignee"
        type: "Administration.Account"
    return_type: "Boolean"
    security_roles: ["LABAdmin"]

  - name: "ACT_CompleteTask"
    type: "action"
    description: "Marks task as completed, triggers workflow progression"
    parameters:
      - name: "Task"
        type: "System.WorkflowUserTask"
      - name: "CompletionData"
        type: "String"
    return_type: "Boolean"
    security_roles: ["LABAdmin", "LABTechnician"]

  - name: "SUB_CheckUserPermissions"
    type: "submicroflow"
    description: "Validates user access rights for specific actions"
    parameters:
      - name: "User"
        type: "Administration.Account"
      - name: "RequiredRole"
        type: "String"
      - name: "EntityToAccess"
        type: "String"
    return_type: "Boolean"
    security_roles: ["LABAdmin", "LABTechnician", "LABViewer"]

  - name: "ACT_ProcessImageQuality"
    type: "action"
    description: "Validates image quality and determines approval status"
    parameters:
      - name: "ImageAcquisition"
        type: "ImageAcquisition"
      - name: "QualityThreshold"
        type: "Decimal"
    return_type: "Boolean"
    security_roles: ["LABAdmin", "LABTechnician"]

  - name: "DS_GetMyTasks"
    type: "datasource"
    description: "Returns tasks filtered by current user with XPath constraints"
    parameters:
      - name: "CurrentUser"
        type: "Administration.Account"
    return_type: "List of System.WorkflowUserTask"
    security_roles: ["LABAdmin", "LABTechnician"]

  - name: "ACT_InitiateWorkflow"
    type: "action"
    description: "Initiates new LAB validation workflow instance"
    parameters:
      - name: "ProductID"
        type: "String"
      - name: "InitiatedBy"
        type: "Administration.Account"
    return_type: "ProductValidation"
    security_roles: ["LABAdmin", "LABTechnician"]

  - name: "ACT_GenerateValidationReport"
    type: "action"
    description: "Generates comprehensive validation report"
    parameters:
      - name: "ProductValidation"
        type: "ProductValidation"
    return_type: "ValidationReport"
    security_roles: ["LABAdmin", "LABTechnician", "LABViewer"]

  - name: "ACT_UpdateAuditTrail"
    type: "action"
    description: "Records action in workflow audit trail"
    parameters:
      - name: "Action"
        type: "String"
      - name: "EntityChanged"
        type: "String"
      - name: "OldValue"
        type: "String"
      - name: "NewValue"
        type: "String"
    return_type: "WorkflowAuditTrail"
    security_roles: ["LABAdmin", "LABTechnician"]

  - name: "ACT_ValidateWorkflowOutcome"
    type: "action"
    description: "Critical TRUE/FALSE decision point for workflow progression"
    parameters:
      - name: "ProductValidation"
        type: "ProductValidation"
      - name: "ValidationCriteria"
        type: "String"
    return_type: "Boolean"
    security_roles: ["LABAdmin"]

# Enumerations Configuration
enumerations:
  - name: "WorkflowStage"
    description: "Stages in the LAB product validation workflow"
    values:
      - name: "ImageAcquisition"
        caption: "Image Acquisition"
        description: "Initial image capture phase"
      - name: "QualityValidation"
        caption: "Quality Validation"
        description: "Critical quality assessment phase"
      - name: "DetailedAcquisition"
        caption: "Detailed Acquisition"
        description: "Enhanced image processing phase"
      - name: "Analysis"
        caption: "Analysis"
        description: "Automated image analysis phase"
      - name: "KPIExtraction"
        caption: "KPI Extraction"
        description: "Performance indicators extraction phase"
      - name: "LABValidation"
        caption: "LAB Validation"
        description: "Final human validation phase"
      - name: "ReportGeneration"
        caption: "Report Generation"
        description: "Comprehensive report creation phase"
      - name: "Completed"
        caption: "Completed"
        description: "Workflow successfully completed"

  - name: "ProcessingStatus"
    description: "Status of image processing and analysis tasks"
    values:
      - name: "Pending"
        caption: "Pending"
        description: "Task is waiting to be processed"
      - name: "InProgress"
        caption: "In Progress"
        description: "Task is currently being processed"
      - name: "Completed"
        caption: "Completed"
        description: "Task has been successfully completed"
      - name: "Failed"
        caption: "Failed"
        description: "Task processing has failed"
      - name: "RequiresReview"
        caption: "Requires Review"
        description: "Task needs manual review"
      - name: "Cancelled"
        caption: "Cancelled"
        description: "Task has been cancelled"

  - name: "ValidationOutcome"
    description: "Final validation decision outcomes"
    values:
      - name: "Approved"
        caption: "Approved"
        description: "Validation passed - product approved"
      - name: "Rejected"
        caption: "Rejected"
        description: "Validation failed - product rejected"
      - name: "Pending"
        caption: "Pending"
        description: "Validation decision is pending"
      - name: "RequiresRework"
        caption: "Requires Rework"
        description: "Product needs additional work"
      - name: "ConditionalApproval"
        caption: "Conditional Approval"
        description: "Approved with conditions"
      - name: "Escalated"
        caption: "Escalated"
        description: "Decision escalated to higher authority"

  - name: "ReportFormat"
    description: "Available formats for validation reports"
    values:
      - name: "PDF"
        caption: "PDF"
        description: "Portable Document Format"
      - name: "HTML"
        caption: "HTML"
        description: "Web page format"
      - name: "JSON"
        caption: "JSON"
        description: "JavaScript Object Notation"
      - name: "XML"
        caption: "XML"
        description: "Extensible Markup Language"
      - name: "Excel"
        caption: "Excel"
        description: "Microsoft Excel spreadsheet"
      - name: "CSV"
        caption: "CSV"
        description: "Comma-separated values"

  - name: "QualityLevel"
    description: "Quality assessment levels for images and processes"
    values:
      - name: "Poor"
        caption: "Poor"
        description: "Quality is below acceptable standards"
      - name: "Fair"
        caption: "Fair"
        description: "Quality meets minimum standards"
      - name: "Good"
        caption: "Good"
        description: "Quality is good and acceptable"
      - name: "VeryGood"
        caption: "Very Good"
        description: "Quality exceeds standard requirements"
      - name: "Excellent"
        caption: "Excellent"
        description: "Quality is exceptional"
      - name: "Outstanding"
        caption: "Outstanding"
        description: "Quality is the highest possible level"

  - name: "TaskPriority"
    description: "Priority levels for workflow tasks"
    values:
      - name: "Critical"
        caption: "Critical"
        description: "Highest priority - immediate attention required"
      - name: "High"
        caption: "High"
        description: "High priority - urgent processing needed"
      - name: "Medium"
        caption: "Medium"
        description: "Medium priority - standard processing"
      - name: "Low"
        caption: "Low"
        description: "Low priority - can be processed when time allows"
      - name: "Deferred"
        caption: "Deferred"
        description: "Processing has been postponed"

  - name: "UserRole"
    description: "User roles in the LAB validation system"
    values:
      - name: "LABAdmin"
        caption: "LAB Administrator"
        description: "Full system administration rights"
      - name: "LABTechnician"
        caption: "LAB Technician"
        description: "Task execution and data entry"
      - name: "LABViewer"
        caption: "LAB Viewer"
        description: "Read-only access to public information"
      - name: "LABSupervisor"
        caption: "LAB Supervisor"
        description: "Supervisory oversight of technicians"
      - name: "SystemAdmin"
        caption: "System Administrator"
        description: "Technical system administration"

  - name: "AuditActionType"
    description: "Types of actions recorded in the audit trail"
    values:
      - name: "Create"
        caption: "Create"
        description: "Entity was created"
      - name: "Update"
        caption: "Update"
        description: "Entity was modified"
      - name: "Delete"
        caption: "Delete"
        description: "Entity was deleted"
      - name: "View"
        caption: "View"
        description: "Entity was accessed for viewing"
      - name: "Export"
        caption: "Export"
        description: "Data was exported"
      - name: "Import"
        caption: "Import"
        description: "Data was imported"
      - name: "Approve"
        caption: "Approve"
        description: "Approval action was taken"
      - name: "Reject"
        caption: "Reject"
        description: "Rejection action was taken"
      - name: "Assign"
        caption: "Assign"
        description: "Task or role was assigned"
      - name: "Complete"
        caption: "Complete"
        description: "Task was completed"

# Security Roles Configuration
security_roles:
  - name: "LABAdmin"
    description: "Full system administration and workflow management"
    permissions:
      entity_access:
        ProductValidation: "CRUD"
        ImageAcquisition: "CRUD"
        DetailedImageAcquisition: "CRUD"
        ImageAnalysis: "CRUD"
        KPIExtraction: "CRUD"
        ValidationResult: "CRUD"
        ValidationReport: "CRUD"
        WorkflowAuditTrail: "CRUD"
        System.WorkflowUserTask: "CRUD"
        System.Workflow: "CRUD"
        Administration.Account: "CRUD"
      page_access:
        - "WorkflowAdminCenter"
        - "TaskInbox"
        - "ValidationResultPage"
        - "AuditTrailViewer"
        - "UserManagement"
        - "ReportGenerationPage"
      microflow_access:
        - "ACT_CreateTask"
        - "ACT_AssignTask"
        - "ACT_CompleteTask"
        - "SUB_CheckUserPermissions"
        - "ACT_ProcessImageQuality"
        - "DS_GetMyTasks"
        - "ACT_InitiateWorkflow"
        - "ACT_GenerateValidationReport"
        - "ACT_UpdateAuditTrail"
        - "ACT_ValidateWorkflowOutcome"

  - name: "LABTechnician"
    description: "Task execution and data entry for assigned workflows"
    permissions:
      entity_access:
        ProductValidation:
          access: "R"
        ImageAcquisition:
          access: "CRUD"
          xpath: "[TechnicianID = $currentUser/Name]"
        DetailedImageAcquisition:
          access: "CRUD"
          xpath: "[ProcessedBy = $currentUser/Name]"
        ImageAnalysis:
          access: "CRUD"
          xpath: "[ProcessedBy = $currentUser/Name]"
        KPIExtraction:
          access: "CRUD"
          xpath: "[ExtractedBy = $currentUser/Name]"
        ValidationResult: "R"
        ValidationReport: "R"
        WorkflowAuditTrail:
          access: "R"
          xpath: "[PerformedBy = $currentUser/Name]"
        System.WorkflowUserTask:
          access: "RU"
          xpath: "[System.WorkflowUserTask_Account = $currentUser]"
      page_access:
        - "TaskInbox"
        - "TaskDashboard"
        - "ImageAcquisitionTask"
        - "DetailedImageAcquisitionTask"
        - "ReportGenerationPage"
      microflow_access:
        - "ACT_CompleteTask"
        - "SUB_CheckUserPermissions"
        - "ACT_ProcessImageQuality"
        - "DS_GetMyTasks"
        - "ACT_InitiateWorkflow"
        - "ACT_GenerateValidationReport"
        - "ACT_UpdateAuditTrail"

  - name: "LABViewer"
    description: "Read-only access to public workflow information"
    permissions:
      entity_access:
        ProductValidation:
          access: "R"
          xpath: "[IsPublic = true]"
        ValidationResult:
          access: "R"
          xpath: "[IsPublic = true]"
        ValidationReport:
          access: "R"
          xpath: "[IsPublic = true]"
        WorkflowAuditTrail:
          access: "R"
          xpath: "[IsPublic = true]"
        System.Workflow:
          access: "R"
          xpath: "[IsPublic = true]"
      page_access:
        - "PublicDashboard"
        - "ReportGenerationPage"
      microflow_access:
        - "SUB_CheckUserPermissions"
        - "ACT_GenerateValidationReport"

# Workflows Configuration - Compatible with Mendix 10.18.1 & Workflow Commons 3.12.1
workflows:
  - name: "LAB_ProductValidation"
    description: "Main LAB product validation workflow with TRUE/FALSE decision logic - optimized for Mendix 10.18.1"
    context_entity: "ProductValidation"
    workflow_commons_version: "3.12.1"
    compatibility_notes: "Uses Workflow Commons 3.12.1 features, compatible with Mendix 10.18.1 workflow engine"
    steps:
      - id: "start"
        name: "Start"
        type: "start_event"
        description: "Workflow initiation - creates ProductValidation context for Mendix 10.18.1"
        implementation_notes: "Configure to auto-populate InitiatedBy field with current user"
      - id: "image_acquisition"
        name: "Image Acquisition"
        type: "user_task"
        description: "Capture product validation images - first interactive step"
        page: "ImageAcquisitionTask"
        assignee_expression: "$WorkflowContext/InitiatedBy"
        outcomes: ["completed", "cancelled"]
        mendix_notes: "Use Workflow Commons 3.12.1 task assignment features"
        implementation_guide: "Page should allow image upload, capture metadata, auto-calculate quality score"
      - id: "quality_validation"
        name: "Quality Validation"
        type: "decision"
        description: "CRITICAL: TRUE/FALSE decision point for image quality - determines workflow path"
        condition: "$WorkflowContext/LAB_ProductValidation/ImageAcquisition/IsQualityApproved"
        outcomes: ["true", "false"]
        business_rules: "TRUE continues to detailed processing, FALSE immediately terminates workflow"
        mendix_notes: "Uses exclusive gateway in Mendix 10.18.1 workflow designer"
      - id: "detailed_acquisition"
        name: "Detailed Image Acquisition"
        type: "user_task"
        description: "Enhanced image processing and analysis (TRUE path only)"
        page: "DetailedImageAcquisitionTask"
        assignee_expression: "$WorkflowContext/InitiatedBy"
        condition: "quality_validation == true"
        outcomes: ["completed"]
        implementation_notes: "Only accessible when quality validation passes"
      - id: "image_analysis"
        name: "Automated Analysis"
        type: "service_task"
        description: "Automated image analysis and algorithm processing"
        microflow: "ACT_ProcessImageAnalysis"
        condition: "quality_validation == true"
        outcomes: ["completed"]
        mendix_notes: "Service task calls microflow for automated processing"
      - id: "kpi_extraction"
        name: "KPI Extraction"
        type: "service_task"
        description: "Extract performance indicators and measurements"
        microflow: "ACT_ExtractKPIs"
        condition: "quality_validation == true"
        outcomes: ["completed"]
        implementation_notes: "Processes ImageAnalysis results to generate KPIs"
      - id: "lab_validation"
        name: "LAB Validation"
        type: "user_task"
        description: "Final validation decision by LAB administrator - human oversight"
        page: "ValidationResultPage"
        assignee_role: "LABAdmin"
        condition: "quality_validation == true"
        outcomes: ["approved", "rejected", "requires_rework"]
        security_notes: "Restricted to LABAdmin role for final decision authority"
      - id: "report_generation"
        name: "Report Generation"
        type: "service_task"
        description: "Generate comprehensive validation report"
        microflow: "ACT_GenerateValidationReport"
        condition: "quality_validation == true AND lab_validation == approved"
        outcomes: ["completed"]
        mendix_notes: "Only generates report for approved validations"
      - id: "workflow_approved"
        name: "Workflow Approved"
        type: "end_event"
        description: "Successful completion - TRUE outcome achieved"
        condition: "quality_validation == true AND lab_validation == approved"
        result: "true"
        business_impact: "Product validation successful, approved for next stage"
      - id: "workflow_rejected"
        name: "Workflow Rejected"
        type: "end_event"
        description: "Validation failed - FALSE outcome, workflow terminated"
        condition: "quality_validation == false OR lab_validation == rejected"
        result: "false"
        business_impact: "Product validation failed, requires corrective action"
    flows:
      - from: "start"
        to: "image_acquisition"
        description: "Initial workflow step"
      - from: "image_acquisition"
        to: "quality_validation"
        condition: "completed"
        description: "Proceed to quality check after image capture"
      - from: "quality_validation"
        to: "detailed_acquisition"
        condition: "true"
        description: "Quality approved - continue processing (TRUE path)"
      - from: "quality_validation"
        to: "workflow_rejected"
        condition: "false"
        description: "Quality rejected - immediate termination (FALSE path)"
      - from: "detailed_acquisition"
        to: "image_analysis"
        condition: "completed"
        description: "Enhanced image ready for analysis"
      - from: "image_analysis"
        to: "kpi_extraction"
        condition: "completed"
        description: "Analysis complete, extract KPIs"
      - from: "kpi_extraction"
        to: "lab_validation"
        condition: "completed"
        description: "KPIs ready for human validation"
      - from: "lab_validation"
        to: "report_generation"
        condition: "approved"
        description: "Validation approved, generate report"
      - from: "lab_validation"
        to: "workflow_rejected"
        condition: "rejected"
        description: "Human validation rejected workflow"
      - from: "report_generation"
        to: "workflow_approved"
        condition: "completed"
        description: "Report generated, workflow successfully completed"
    mendix_10_18_1_notes: |
      Implementation notes for Mendix 10.18.1:
      - Use exclusive gateways for decision points
      - Configure task assignments using Workflow Commons 3.12.1
      - Set up proper event handlers for state changes
      - Configure timeout settings for user tasks
      - Use workflow context effectively for data passing
      - Test with different user roles and scenarios
    workflow_commons_3_12_1_setup: |
      Workflow Commons 3.12.1 Configuration:
      1. Install Workflow Commons 3.12.1 from App Store
      2. Configure in App Settings > Workflows tab
      3. Set User entity to Administration.Account
      4. Add required pages to navigation
      5. Configure security roles properly
      6. Test task assignment and completion

# Pages Configuration
pages:
  - name: "WorkflowAdminCenter"
    type: "admin_dashboard"
    description: "Central administration hub for workflow management"
    security_roles: ["LABAdmin"]
    layout: "Dashboard"
    components:
      - type: "DataGrid"
        entity: "System.Workflow"
        title: "All Workflows"
      - type: "DataGrid"
        entity: "System.WorkflowUserTask"
        title: "All Tasks"
      - type: "ActionButton"
        action: "ACT_AssignTask"
        title: "Reassign Task"
      - type: "Chart"
        data: "WorkflowMetrics"
        title: "Workflow Performance"

  - name: "TaskInbox"
    type: "user_dashboard"
    description: "Personal task management interface for users"
    security_roles: ["LABTechnician"]
    layout: "TaskManagement"
    components:
      - type: "DataGrid"
        entity: "System.WorkflowUserTask"
        title: "My Tasks"
        constraint: "[AssignedTo = $currentUser]"
      - type: "ActionButton"
        action: "ACT_CompleteTask"
        title: "Complete Task"
      - type: "FormView"
        entity: "ProductValidation"
        title: "Task Details"

  - name: "TaskDashboard"
    type: "user_dashboard"
    description: "Personal performance metrics and task history"
    security_roles: ["LABTechnician"]
    layout: "Dashboard"
    components:
      - type: "Chart"
        data: "MyTaskMetrics"
        title: "My Performance"
      - type: "DataGrid"
        entity: "System.WorkflowEndedUserTask"
        title: "Completed Tasks"
        constraint: "[CompletedBy = $currentUser]"
      - type: "StatCard"
        metric: "TasksCompleted"
        title: "Tasks Completed This Week"

  - name: "PublicDashboard"
    type: "viewer_dashboard"
    description: "Read-only dashboard for public workflow information"
    security_roles: ["LABViewer"]
    layout: "ReadOnlyDashboard"
    components:
      - type: "Chart"
        data: "PublicWorkflowMetrics"
        title: "Workflow Statistics"
      - type: "DataGrid"
        entity: "ValidationReport"
        title: "Public Reports"
        constraint: "[IsPublic = true]"
      - type: "StatCard"
        metric: "TotalWorkflows"
        title: "Total Workflows"

  - name: "ImageAcquisitionTask"
    type: "task_page"
    description: "Specialized page for image capture and quality validation"
    security_roles: ["LABTechnician"]
    layout: "TaskForm"
    components:
      - type: "ImageUploader"
        entity: "ImageAcquisition"
        field: "ImageFile"
        title: "Upload Image"
      - type: "FormView"
        entity: "ImageAcquisition"
        title: "Image Details"
      - type: "ActionButton"
        action: "ACT_ProcessImageQuality"
        title: "Validate Quality"
      - type: "ConditionalView"
        condition: "IsQualityApproved"
        title: "Quality Status"

  - name: "DetailedImageAcquisitionTask"
    type: "task_page"
    description: "Enhanced image processing and analysis interface"
    security_roles: ["LABTechnician"]
    layout: "TaskForm"
    components:
      - type: "ImageViewer"
        entity: "DetailedImageAcquisition"
        field: "EnhancedImageFile"
        title: "Enhanced Image"
      - type: "FormView"
        entity: "DetailedImageAcquisition"
        title: "Processing Details"
      - type: "TextArea"
        field: "ProcessingNotes"
        title: "Processing Notes"
      - type: "ActionButton"
        action: "ACT_CompleteTask"
        title: "Complete Processing"

  - name: "ValidationResultPage"
    type: "task_page"
    description: "Final validation decision interface"
    security_roles: ["LABAdmin"]
    layout: "ValidationForm"
    components:
      - type: "FormView"
        entity: "ValidationResult"
        title: "Validation Decision"
      - type: "DropDown"
        field: "Result"
        enumeration: "ValidationOutcome"
        title: "Final Decision"
      - type: "TextArea"
        field: "Comments"
        title: "Validation Comments"
      - type: "ActionButton"
        action: "ACT_ValidateWorkflowOutcome"
        title: "Submit Decision"

  - name: "ReportGenerationPage"
    type: "report_page"
    description: "Comprehensive report generation and viewing"
    security_roles: ["LABAdmin", "LABTechnician", "LABViewer"]
    layout: "ReportLayout"
    components:
      - type: "FormView"
        entity: "ValidationReport"
        title: "Report Configuration"
      - type: "DropDown"
        field: "ReportFormat"
        enumeration: "ReportFormat"
        title: "Report Format"
      - type: "ActionButton"
        action: "ACT_GenerateValidationReport"
        title: "Generate Report"
      - type: "FileDownloader"
        field: "ReportFile"
        title: "Download Report"

  - name: "AuditTrailViewer"
    type: "admin_page"
    description: "Complete audit trail viewer for compliance tracking"
    security_roles: ["LABAdmin"]
    layout: "AuditLayout"
    components:
      - type: "DataGrid"
        entity: "WorkflowAuditTrail"
        title: "Audit Trail"
      - type: "SearchBox"
        target: "AuditTrail"
        title: "Search Actions"
      - type: "DatePicker"
        field: "ActionDate"
        title: "Filter by Date"
      - type: "ExportButton"
        data: "AuditTrail"
        title: "Export Audit Log"

  - name: "UserManagement"
    type: "admin_page"
    description: "User and role management interface"
    security_roles: ["LABAdmin"]
    layout: "UserManagement"
    components:
      - type: "DataGrid"
        entity: "Administration.Account"
        title: "Users"
      - type: "FormView"
        entity: "Administration.Account"
        title: "User Details"
      - type: "RoleSelector"
        field: "UserRoles"
        title: "Assign Roles"
      - type: "ActionButton"
        action: "ACT_UpdateUserRoles"
        title: "Update Roles"